{% extends "::base.html.twig" %}

{% block title %}Market{% endblock %}

{% block body %}
    <h1>Liste des produits à vendre</h1>
    <table>
        <tr>
            <th>Nom</th>
            <th>Prix</th>
            <th>Quantité</th>
            <th>Vendeur</th>
            <th>Action</th>
        </tr>
        {% for userproduct in products %}
            <tr class="product{{ userproduct.product.id }}">
                <td>{{ userproduct.product.name }}</td>
                <td>{{ userproduct.price }}</td>
                <td>{{ userproduct.qty }}</td>
                <td>{{ userproduct.user.lastname }} {{ userproduct.user.firstname }}</td>
                <td><button onclick="addCart({{ userproduct.qty }},{{ userproduct.product.id }});">Ajouter</button></td>
                <td id="errorqty{{ userproduct.product.id }}" style="display:none;">Vous avez dépassé la quantité du produit disponible</td>
            </tr>
        {% endfor %}
    </table>
    <script>
        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        };

        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for(var i=0; i<ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1);
                if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
            }
            return "";
        };

        var cart = getCookie('cart')!="" ? JSON.parse(getCookie('cart')) : new Array();
        function addCart(maxQty,id){
            console.log('debut');
            console.log(cart);
            var trouve = false;
            for(var i = 0; i < cart.length; i++) {
                if (cart[i].id == id) {
                    if (cart[i].qty < maxQty) {
                        cart[i].qty = cart[i].qty + 1;
                    } else {
                        document.getElementById('errorqty'+id).style.display="block";
                    }
                    trouve = true;
                }
            }

            if (!trouve) {
                console.log('init');
                cart.push({id: id, qty: 1});
            }

            setCookie('cart',JSON.stringify(cart),3);

            console.log('fin');
            console.log(cart);
        };
    </script>
{% endblock %}